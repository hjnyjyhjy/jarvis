# Offline Models & Setup

هذا الملف يشرح كيف تجعل تطبيق Platinum Arabic AI يعمل دون اتصال بالكامل بعد تنزيل النماذج المطلوبة.

مبدأيّات:
- التطبيق يقدم واجهات محلية لـ STT (تحويل كلام إلى نص)، NLU (فهم النية)، TTS (تحويل نص إلى كلام)، وwake-word (كلمة الاستيقاظ).
- النماذج الثقيلة (مثل Whisper أو Coqui) يجب تنزيلها مرة واحدة وحفظها في مجلد التطبيق المخصص أو في التخزين المشفر.

مواقع النموذج الموصى بها وأحجام تقريبية:
- Whisper (small/medium): يعتمد على التوزيع؛ قد يتراوح بين 50-1500MB حسب النسخة. استخدم النسخة المتكيفة للهواتف (whisper.cpp / ggml) إن أمكن.
- Vosk (Arabic models): ~30-200MB حسب اللغة.
- Porcupine / Precise-like wake-word: ~0.5-5MB (خفيف)
- Speaker recognition model (d-vector): ~10-50MB
- Coqui TTS (light): 50-400MB حسب جودة الصوت

توصيات تخزين:
- ضع الملفات داخل `context.filesDir` أو `context.getExternalFilesDir("models")` مع صلاحيات التخزين المناسبة.
- إن أردت حماية النماذج، خزّنها ضمن شهادة مشفرة أو استخدم `SQLCipher`/`EncryptedFile`.

تنزيل عبر التطبيق: (الشغيل الافتراضي)
1. افتح `الإعدادات` → اضغط `تحميل النماذج`.
2. سيبدأ `ModelDownloadWorker` (WorkManager) تنزيل الملفات إلى المجلد المحدد.
3. بعد اكتمال التنزيل، قم بإعادة تشغيل الخدمة أو ابدأ التهيئة المحلية لنظام الـ STT/ TTS/ NLU.

Manifest للنماذج:
- أضفنا الآن `app/src/main/assets/models_manifest.json` كملف مثال يحوي قائمة النماذج (اسم الملف، رابط التنزيل، الحجم، وsha256 إن وُجد).
- التطبيق يمكنه قراءة هذا الملف لعرض قائمة النماذج للمستخدم وتمكين التنزيل بنقرة واحدة.

كيفية إضافة روابط نماذج حقيقية وsha256:
- استخدم السكربت `scripts/download_and_hash.sh <url>` لتنزيل الملف وحساب sha256 الخاص به، ثم انسخ القيمة إلى الحقل `sha256` في الإدخال المناسب داخل `app/src/main/assets/models_manifest.json`.
- مصادر موصى بها: نماذج Vosk متاحة في https://alphacephei.com/vosk/models (اختر نماذج صغيرة للهواتف). بالنسبة للعربية، ابحث في مستودعات المجتمع أو استضف النموذج بنفسك وأضف الرابط والـ sha256 إلى الـ manifest.

التقدّم والموثوقية:
- `ModelDownloadWorker` الآن يرسل تقدّم تنزيل (0-100) عبر WorkManager بحيث يمكن للواجهة عرض شريط تقدم.
- يدعم التحقق عبر `sha256` عند توفر قيمة في مدخلات العمل؛ إذا لم تتطابق الهاشات سيحذف الملف ويعاد المحاولة.

وضعية العمل: Offline vs Online
- التطبيق يعمل الآن في وضعيْن: **Offline** (الافتراضي) و**Online** (اختياري).
- **Offline**: يستخدم نماذج محلية (Vosk للـ STT، نماذج مخزنة في `filesDir/models/...`) ويعمل بالكامل دون اتصال بعد تنزيل النماذج.
- يدعم التطبيق حالياً نماذج لكل من **الإنجليزية** و**العربية**. اختر اللغة في `الإعدادات` أو اتركها على `Auto` ليعمل بالإنجليزية افتراضياً.
- **Online**: يسمح بتكوين نقاط نهاية (endpoints) خارجية للـ NLU (وASR إن وُجد). يمكن إدخال رابط خدمة NLU في `الإعدادات` → `NLU endpoint (POST)`، وسيرسل التطبيق النصوص إلى ذلك الرابط بصيغة JSON {"text": "..."} ويتوقع استجابة JSON بسيطة ({"intent":"...","confidence":0.9,"response":"..."}).

الملاحظات المهمة:
- لا توجد خدمات سحابية مضمنة افتراضياً؛ إذا فعلت خيار Online، يجب أن تزود التطبيق بخدمة NLU/ASR خاصة بك أو خدمة خارجية متاحة (توجد تكوينات جاهزة في `Settings`).
- الهدف هو أن يبقى التطبيق مجانيًا ومفتوحًا؛ أي خدمات سحابية تستخدمها قد تفرض قيود أو تكاليف خارجية وتكون خارج نطاق هذا المستودع.

ملاحظات تقنية لتنفيذ محلي فعّال:
- استخدم wake-word محلي دائماً لتوفير الطاقة — لا تقم بتشغيل STT دائمة الاستماع.
- شغّل STT فقط عند الاستيقاظ؛ تعامل مع الصوت في دفق (stream) وليس بتحميل كامل الملف.
- استخدم quantized models (ggml/ONNX quantized) لتقليل الذاكرة واستهلاك CPU.
- استخدم `WorkManager` مع قيود على الشبكة (`NetworkType.CONNECTED`) وقيود البطارية إذا لزم.

الخطوات التالية للمطورين:
- اتبع الملفات في `app/src/main/java/com/platinumassistant/core/ai` لربط نماذج STT/TTS/NLU.
- راجع `ModelDownloadWorker.kt` كمثال لتنزيل الملفات وحفظها.

إذا أردت، أستطيع:
- إضافة واجهة تحميل مباشرة داخل التطبيق مع شريط تقدم وتحكم في تنزيل كل نموذج.
- ربط مكتبات مثل `whisper.cpp`, `Vosk` أو `Coqui` مع شريحة JNI/NDK للآداء الأفضل.
